## 4.3 サブネットとアベイラビリティーゾーン

### 4.3.2 IPv4 CIDR の設計方法

CIDR は Classless Inter-Domain Routing の略でサイダーと読むらしい。
IP アドレスを任意の位置でネットワーク部とホスト部に割り当てる技術のこと。
例えば 10.0.0.0/16 は IP アドレスの先頭から 16 ビットまでをネットワーク部、残り 16 ビットをホスト部に割り当てるという意味。

Amazon Virtual Private Cloud (Amazon VPC) では VPC をさらに複数のサブネットに分割できる。
これは公開範囲の区別や冗長化を行う時に役立つ。
サブネットを指定するときには IP アドレスのホスト部からサブネットとリソースに振り分けるビット数を指定する必要がある。
例えば 10.0.0.0/16 の場合、ホスト部である 16 ビットをサブネットとリソースに振り分ける。
例えば 4 ビットをサブネットに、12 ビットをリソースに振り分けると理論上

- 2^4 = 16 個のサブネット、
- 2^12 - 5 = 4091 個のリソース

を作成できる。
ここで 5 は AWS が予約しているリソースが 5 個あることを示している。

## 4.4 インターネットゲートウェイ

VPC にデプロイしたリソースはそのままではインターネットと**双方向**通信できない。
VPC 内のリソースはプライベート IP しか知らず、AWS が自動で割り当てているパブリック IP を知らないのが原因。
2 つの IP を紐づけて外部と双方向通信できるようにするのが Internet Gateway (IGW) の役割。

IGW は VPC に対してアタッチされるのが特徴なので、アベイラビリティーゾーン (AZ) に対して可用性がある。
つまり AZ1 と AZ2 は IGW を共有するので、AZ1 がダウンしても AZ2 でサービスを継続できる。

## 4.5 NAT ゲートウェイ

VPC 内の全てのリソースを外部に公開する場合は IGW で十分だが、プライベートサブネットがある場合に困る。
例えば EC サイトを AWS にデプロイしたとする。
ユーザはフロントエンドに直接アクセスし決済情報などを入力する。
バックエンドは入力された決済情報を外部サービスに送信し決済の承認を得る必要がある。
バックエンドをフロントエンド同様に外部公開してしまうと不正アクセスによる個人情報漏えいのリスクがある。
これを防ぐためには外部からバックエンドのアクセスを遮断し、バックエンドから外部へのアクセスのみを許可する必要がある。
この機能を実現するのが NAT ゲートウェイ (NGW) である。
つまり NAT ゲートウェイが実現するのは **単方向**通信である点が IGW と異なる。
また、NAT ゲートウェイはパブリックサブネットにアタッチされる点も異なる。

## 4.6 ルートテーブル

IGW、NGW に hoge への通信は huga を経由させるといった割り当てルールを定義する必要がある。
割り当てルールの定義に当たるものがルートテーブルである。
ルートテーブルは送信先（通信先）とターゲット（経由させるもの）から構成されており、例えば以下のようになる。

|送信先|ターゲット|
|---|---|
|10.0.0.0/16|Local|
|0.0.0.0/0|IGW|

ルートテーブルは先頭行から順に解決していく。
例えば VPC の CIDR アドレスが 10.0.0.0/16 であり、通信先が 10.0.x.y (VPC 内への通信) だった場合、1 行目で指定した送信先に含まれるのでそのまま通信させる。
一方で通信先が x.y.z.w であり 10.0.0.0/16 の範囲外だった場合、2 行目が適用され VPC 外部へ通信するために IGW を経由することになる。
ここで 0.0.0.0/0 は先頭から 0 ビットが 0.0.0.0 と一致するという意味で、全ての通信先が網羅される。
これをデフォルトルートという。